<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>История генераций - Chiptune Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
    <style>
        .navbar {
            min-height: 70px;
        }
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        .track-info {
            flex-grow: 1;
        }
        .track-info p {
            margin: 0;
            line-height: 1.5;
        }
        .edit-button-container {
            display: flex;
            flex-direction: row;
            gap: 10px;
            margin-bottom: 10px;
        }
        .edit-form {
            display: none;
        }
        .edit-input {
            width: 300px;
            margin-right: 10px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
    <div class="container-fluid">
        <a class="nav-link" href="/">Главная страница</a>
        <a class="nav-link" href="/auth">Авторизация</a>
        <button id="navbarLogoutButton" class="btn btn-danger ms-auto" style="display: none;">Выйти</button>
    </div>
</nav>

<h1 style="margin-top: 50px">История генераций</h1>
<div class="history-list" id="history-list">
    <p id="no-tracks" style="display: none;">Сгенерированных треков нет.</p>
</div>

<script src="/static/auth.js"></script>
<script>
    const historyList = document.getElementById('history-list');
    const noTracksMessage = document.getElementById('no-tracks');

    firebase.auth().onAuthStateChanged((user) => {
        if (user) {
            loadUserTracks(user.uid);
        } else {
            window.location.href = '/auth';
        }
    });

    function loadUserTracks(userId) {
        const tracksRef = firebase.firestore()
            .collection('users')
            .doc(userId)
            .collection('tracks')
            .orderBy('createdAt', 'desc');

        tracksRef.get().then((querySnapshot) => {
            historyList.innerHTML = '';
            if (querySnapshot.empty) {
                noTracksMessage.style.display = 'block';
                return;
            }

            noTracksMessage.style.display = 'none';
            querySnapshot.forEach((doc) => {
                const track = doc.data();
                const trackElement = document.createElement('div');
                trackElement.className = 'history-item';

                const creationDate = track.createdAt ? track.createdAt.toDate().toLocaleString('ru-RU') : 'Неизвестно';

                const trackInfo = document.createElement('div');
                trackInfo.className = 'track-info';
                trackInfo.innerHTML = `
                    <p><strong>Название:</strong> <a href="/?track_id=${track.trackCode}">${track.title}</a></p>
                    <p><strong>ID:</strong> ${track.trackCode}</p>
                    <p><strong>Сгенерировано:</strong> ${creationDate}</p>
                `;

                const editButtonContainer = document.createElement('div');
                editButtonContainer.className = 'edit-button-container';

                const editButton = document.createElement('button');
                editButton.className = 'btn btn-secondary btn-sm';
                editButton.textContent = 'Изменить название';
                editButton.onclick = () => toggleEditForm(trackElement);

                const deleteButton = document.createElement('button');
                deleteButton.className = 'btn btn-danger btn-sm';
                deleteButton.textContent = 'Удалить';
                deleteButton.onclick = async () => {
                    const user = firebase.auth().currentUser;
                    if (!user) {
                        alert("Пользователь не авторизован");
                        return;
                    }
                    try {
                        const token = await user.getIdToken();
                        await fetch(`/tracks/${track.trackCode}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        trackElement.remove();
                        alert("Трек удален");
                    } catch (error) {
                        console.error('Ошибка удаления трека:', error);
                        alert('Ошибка при удалении трека');
                    }
                };

                editButtonContainer.appendChild(editButton);
                editButtonContainer.appendChild(deleteButton);

                const editForm = document.createElement('div');
                editForm.className = 'edit-form';
                editForm.innerHTML = `
                    <input type="text" class="form-control edit-input" maxlength="40" value="${track.title}" placeholder="Введите новое название">
                    <button class="btn btn-success btn-sm" onclick="saveTitle('${track.trackCode}', '${userId}', this)">Сохранить</button>
                    <button class="btn btn-danger btn-sm" onclick="cancelEdit(this)">Отмена</button>
                `;

                const rightColumn = document.createElement('div');
                rightColumn.style.display = 'flex';
                rightColumn.style.flexDirection = 'column';
                rightColumn.appendChild(editButtonContainer);
                rightColumn.appendChild(editForm);

                trackElement.appendChild(trackInfo);
                trackElement.appendChild(rightColumn);
                historyList.appendChild(trackElement);
            });
        }).catch((error) => {
            console.error('Ошибка загрузки треков:', error);
            noTracksMessage.style.display = 'block';
        });
    }

    function toggleEditForm(trackElement) {
        const editForm = trackElement.querySelector('.edit-form');
        const editButton = trackElement.querySelector('.btn-secondary');
        const isVisible = editForm.style.display === 'block';
        editForm.style.display = isVisible ? 'none' : 'block';
        editButton.disabled = !isVisible;
    }

    function cancelEdit(cancelButton) {
        const editForm = cancelButton.closest('.edit-form');
        editForm.style.display = 'none';
        const trackElement = editForm.closest('.history-item');
        trackElement.querySelector('.btn-secondary').disabled = false;
    }

    function saveTitle(trackId, userId, saveButton) {
        const editForm = saveButton.parentElement;
        const newTitle = editForm.querySelector('input').value.trim();

        if (!newTitle) {
            alert('Название не может быть пустым.');
            return;
        }

        if (newTitle.length > 40) {
            alert('Название не может превышать 40 символов.');
            return;
        }

        firebase.firestore()
            .collection('users')
            .doc(userId)
            .collection('tracks')
            .doc(trackId)
            .update({ title: newTitle })
            .then(() => {
                const trackElement = editForm.closest('.history-item');
                const trackInfo = trackElement.querySelector('.track-info');
                trackInfo.querySelector('a').textContent = newTitle;
                editForm.style.display = 'none';
                trackElement.querySelector('.btn-secondary').disabled = false;
                alert('Название успешно обновлено!');
            })
            .catch((error) => {
                console.error('Ошибка при обновлении названия:', error);
                alert('Ошибка при обновлении названия: ' + error.message);
            });
    }
</script>
</body>
</html>